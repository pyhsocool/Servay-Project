// 한국어 설문 질문 데이터
const questionsKO = [
    {
        question: "데이터 필터 기능을 사용할 수 있나요?",
        options: [
            { text: "고급 필터 포함 자유롭게 사용", score: 4 },
            { text: "기본 필터만 사용 가능", score: 3 },
            { text: "본 적 있지만 사용 못함", score: 2 },
            { text: "전혀 모름", score: 1 }
        ]
    },
    {
        question: "셀 참조 방식(상대/절대/혼합) 차이를 알고 있나요?",
        options: [
            { text: "완벽히 이해, 상황에 맞게 사용", score: 4 },
            { text: "의미만 대략적으로 앎", score: 3 },
            { text: "들어본적 있음", score: 2 },
            { text: "전혀 모름", score: 1 }
        ]
    },
    {
        question: "피벗 테이블을 활용할 수 있나요?",
        options: [
            { text: "고급 피벗 테이블 사용 가능", score: 4 },
            { text: "기본 피벗 테이블만 사용", score: 3 },
            { text: "개념만 알고 있음", score: 2 },
            { text: "전혀 모름", score: 1 }
        ]
    },
    {
        question: "조건부 서식 기능을 사용할 수 있나요?",
        options: [
            { text: "복잡한 규칙 포함 자유롭게 활용", score: 4 },
            { text: "간단한 조건부 서식만 활용", score: 3 },
            { text: "기능을 봤지만 사용 경험 없음", score: 2 },
            { text: "전혀 모름", score: 1 }
        ]
    },
    {
        question: "함수 사용 능력은 어느 정도인가요?",
        options: [
            { text: "복잡한 중첩 함수도 작성 가능", score: 4 },
            { text: "기본 함수(SUM, AVERAGE 등) 사용", score: 3 },
            { text: "함수 의미만 알고 직접 작성 어려움", score: 2 },
            { text: "전혀 사용 못함", score: 1 }
        ]
    },
    {
        question: "매크로(VBA)를 활용할 수 있나요?",
        options: [
            { text: "직접 코드 작성 가능", score: 4 },
            { text: "녹화 기능으로 간단한 매크로 생성", score: 3 },
            { text: "매크로 개념만 알고 있음", score: 2 },
            { text: "전혀 모름", score: 1 }
        ]
    },
    {
        question: "데이터 유효성 검사 기능을 활용할 수 있나요?",
        options: [
            { text: "복잡한 규칙 설정 가능", score: 4 },
            { text: "간단한 유효성 검사만 설정 가능", score: 3 },
            { text: "기능을 들어봤지만 사용 못함", score: 2 },
            { text: "전혀 모름", score: 1 }
        ]
    },
    {
        question: "차트 작성 능력은 어느 정도인가요?",
        options: [
            { text: "복잡한 사용자 지정 차트 생성 가능", score: 4 },
            { text: "기본 차트 유형 활용 가능", score: 3 },
            { text: "간단한 차트만 만들 수 있음", score: 2 },
            { text: "차트 작성 못함", score: 1 }
        ]
    },
    {
        question: "데이터 분석 도구(분석 도구 모음)를 활용할 수 있나요?",
        options: [
            { text: "다양한 분석 도구 능숙하게 활용", score: 4 },
            { text: "기본적인 분석 도구만 사용", score: 3 },
            { text: "도구의 존재는 알지만 사용 못함", score: 2 },
            { text: "전혀 모름", score: 1 }
        ]
    },
    {
        question: "엑셀 파일 간 데이터 연결 및 통합을 할 수 있나요?",
        options: [
            { text: "복잡한 외부 데이터 연결 가능", score: 4 },
            { text: "간단한 파일 간 연결만 가능", score: 3 },
            { text: "방법은 알지만 실제로 해본 적 없음", score: 2 },
            { text: "전혀 모름", score: 1 }
        ]
    }
];

// 영어 설문 질문 데이터
const questionsEN = [
    {
        question: "Can you use the data filter function?",
        options: [
            { text: "Can freely use including advanced filters", score: 4 },
            { text: "Can only use basic filters", score: 3 },
            { text: "Have seen it but can't use it", score: 2 },
            { text: "Don't know at all", score: 1 }
        ]
    },
    {
        question: "Do you understand the differences between cell reference methods (relative/absolute/mixed)?",
        options: [
            { text: "Perfectly understand and use appropriately", score: 4 },
            { text: "Roughly know the meaning", score: 3 },
            { text: "Have heard of it", score: 2 },
            { text: "Don't know at all", score: 1 }
        ]
    },
    {
        question: "Can you utilize pivot tables?",
        options: [
            { text: "Can use advanced pivot tables", score: 4 },
            { text: "Can only use basic pivot tables", score: 3 },
            { text: "Only know the concept", score: 2 },
            { text: "Don't know at all", score: 1 }
        ]
    },
    {
        question: "Can you use conditional formatting?",
        options: [
            { text: "Can freely use including complex rules", score: 4 },
            { text: "Can only use simple conditional formatting", score: 3 },
            { text: "Have seen the feature but never used it", score: 2 },
            { text: "Don't know at all", score: 1 }
        ]
    },
    {
        question: "How proficient are you with Excel functions?",
        options: [
            { text: "Can write complex nested functions", score: 4 },
            { text: "Can use basic functions (SUM, AVERAGE, etc.)", score: 3 },
            { text: "Only know what functions mean but can't write them", score: 2 },
            { text: "Can't use at all", score: 1 }
        ]
    },
    {
        question: "Can you utilize macros (VBA)?",
        options: [
            { text: "Can write code directly", score: 4 },
            { text: "Can create simple macros using the recorder", score: 3 },
            { text: "Only know the concept of macros", score: 2 },
            { text: "Don't know at all", score: 1 }
        ]
    },
    {
        question: "Can you use data validation features?",
        options: [
            { text: "Can set complex rules", score: 4 },
            { text: "Can only set simple validations", score: 3 },
            { text: "Have heard of the feature but can't use it", score: 2 },
            { text: "Don't know at all", score: 1 }
        ]
    },
    {
        question: "How would you rate your chart creation skills?",
        options: [
            { text: "Can create complex custom charts", score: 4 },
            { text: "Can use basic chart types", score: 3 },
            { text: "Can only create simple charts", score: 2 },
            { text: "Can't create charts", score: 1 }
        ]
    },
    {
        question: "Can you use data analysis tools (Analysis ToolPak)?",
        options: [
            { text: "Can skillfully use various analysis tools", score: 4 },
            { text: "Can only use basic analysis tools", score: 3 },
            { text: "Know they exist but can't use them", score: 2 },
            { text: "Don't know at all", score: 1 }
        ]
    },
    {
        question: "Can you connect and consolidate data between Excel files?",
        options: [
            { text: "Can connect complex external data", score: 4 },
            { text: "Can only connect simple files", score: 3 },
            { text: "Know how but never done it in practice", score: 2 },
            { text: "Don't know at all", score: 1 }
        ]
    }
];

// 스페인어 설문 질문 데이터
const questionsES = [
    {
        question: "¿Puede utilizar la función de filtro de datos?",
        options: [
            { text: "Puedo usar libremente incluso filtros avanzados", score: 4 },
            { text: "Solo puedo usar filtros básicos", score: 3 },
            { text: "Lo he visto pero no puedo usarlo", score: 2 },
            { text: "No lo conozco en absoluto", score: 1 }
        ]
    },
    {
        question: "¿Entiende las diferencias entre los métodos de referencia de celda (relativa/absoluta/mixta)?",
        options: [
            { text: "Entiendo perfectamente y uso apropiadamente", score: 4 },
            { text: "Conozco aproximadamente el significado", score: 3 },
            { text: "He oído hablar de ello", score: 2 },
            { text: "No lo conozco en absoluto", score: 1 }
        ]
    },
    {
        question: "¿Puede utilizar tablas dinámicas?",
        options: [
            { text: "Puedo usar tablas dinámicas avanzadas", score: 4 },
            { text: "Solo puedo usar tablas dinámicas básicas", score: 3 },
            { text: "Solo conozco el concepto", score: 2 },
            { text: "No lo conozco en absoluto", score: 1 }
        ]
    },
    {
        question: "¿Puede usar el formato condicional?",
        options: [
            { text: "Puedo usar libremente incluso reglas complejas", score: 4 },
            { text: "Solo puedo usar formato condicional simple", score: 3 },
            { text: "He visto la función pero nunca la he usado", score: 2 },
            { text: "No lo conozco en absoluto", score: 1 }
        ]
    },
    {
        question: "¿Qué nivel de conocimiento tiene con las funciones de Excel?",
        options: [
            { text: "Puedo escribir funciones anidadas complejas", score: 4 },
            { text: "Puedo usar funciones básicas (SUMA, PROMEDIO, etc.)", score: 3 },
            { text: "Solo sé lo que significan las funciones pero no puedo escribirlas", score: 2 },
            { text: "No puedo usarlas en absoluto", score: 1 }
        ]
    },
    {
        question: "¿Puede utilizar macros (VBA)?",
        options: [
            { text: "Puedo escribir código directamente", score: 4 },
            { text: "Puedo crear macros simples usando la grabadora", score: 3 },
            { text: "Solo conozco el concepto de macros", score: 2 },
            { text: "No lo conozco en absoluto", score: 1 }
        ]
    },
    {
        question: "¿Puede usar funciones de validación de datos?",
        options: [
            { text: "Puedo establecer reglas complejas", score: 4 },
            { text: "Solo puedo establecer validaciones simples", score: 3 },
            { text: "He oído de la función pero no puedo usarla", score: 2 },
            { text: "No lo conozco en absoluto", score: 1 }
        ]
    },
    {
        question: "¿Cómo calificaría sus habilidades de creación de gráficos?",
        options: [
            { text: "Puedo crear gráficos personalizados complejos", score: 4 },
            { text: "Puedo usar tipos de gráficos básicos", score: 3 },
            { text: "Solo puedo crear gráficos simples", score: 2 },
            { text: "No puedo crear gráficos", score: 1 }
        ]
    },
    {
        question: "¿Puede usar herramientas de análisis de datos?",
        options: [
            { text: "Puedo usar hábilmente varias herramientas de análisis", score: 4 },
            { text: "Solo puedo usar herramientas de análisis básicas", score: 3 },
            { text: "Sé que existen pero no puedo usarlas", score: 2 },
            { text: "No lo conozco en absoluto", score: 1 }
        ]
    },
    {
        question: "¿Puede conectar y consolidar datos entre archivos de Excel?",
        options: [
            { text: "Puedo conectar datos externos complejos", score: 4 },
            { text: "Solo puedo conectar archivos simples", score: 3 },
            { text: "Sé cómo hacerlo pero nunca lo he hecho en la práctica", score: 2 },
            { text: "No lo conozco en absoluto", score: 1 }
        ]
    }
];

// 한국어 결과 메시지 데이터
const resultMessagesKO = [
    {
        minScore: 10,
        maxScore: 20,
        message: "초보 수준: 엑셀의 기본 기능에 대한 이해가 필요합니다. 기초적인 기능부터 익혀나가는 것을 권장합니다."
    },
    {
        minScore: 21,
        maxScore: 30,
        message: "기초 수준: 엑셀의 기본 기능을 이해하고 있지만, 심화 기능 학습이 필요합니다. 필터, 함수 등 자주 사용하는 기능을 더 익혀보세요."
    },
    {
        minScore: 31,
        maxScore: 35,
        message: "중급 수준: 엑셀을 능숙하게 다룰 수 있습니다. 피벗 테이블, 고급 함수 등을 학습하여 능력을 향상시켜 보세요."
    },
    {
        minScore: 36,
        maxScore: 40,
        message: "고급 수준: 엑셀을 전문적으로 활용할 수 있는 수준입니다. 매크로, 고급 데이터 분석 등 더 심화된 기능을 익히면 전문가 수준에 도달할 수 있습니다."
    }
];

// 영어 결과 메시지 데이터
const resultMessagesEN = [
    {
        minScore: 10,
        maxScore: 20,
        message: "Beginner Level: You need to understand the basic functions of Excel. It is recommended to learn basic functions first."
    },
    {
        minScore: 21,
        maxScore: 30,
        message: "Basic Level: You understand the basic functions of Excel, but need to learn advanced functions. Try to learn more about frequently used functions such as filters and formulas."
    },
    {
        minScore: 31,
        maxScore: 35,
        message: "Intermediate Level: You can handle Excel skillfully. Learn pivot tables, advanced functions, etc. to improve your skills."
    },
    {
        minScore: 36,
        maxScore: 40,
        message: "Advanced Level: You can use Excel professionally. You can reach an expert level by learning more advanced functions such as macros and advanced data analysis."
    }
];

// 스페인어 결과 메시지 데이터
const resultMessagesES = [
    {
        minScore: 10,
        maxScore: 20,
        message: "Nivel Principiante: Necesita comprender las funciones básicas de Excel. Se recomienda aprender primero las funciones básicas."
    },
    {
        minScore: 21,
        maxScore: 30,
        message: "Nivel Básico: Comprende las funciones básicas de Excel, pero necesita aprender funciones avanzadas. Intente aprender más sobre funciones de uso frecuente como filtros y fórmulas."
    },
    {
        minScore: 31,
        maxScore: 35,
        message: "Nivel Intermedio: Puede manejar Excel con habilidad. Aprenda tablas dinámicas, funciones avanzadas, etc. para mejorar sus habilidades."
    },
    {
        minScore: 36,
        maxScore: 40,
        message: "Nivel Avanzado: Puede usar Excel profesionalmente. Puede alcanzar un nivel experto aprendiendo funciones más avanzadas como macros y análisis de datos avanzados."
    }
];

// 현재 사용 중인 언어 데이터
let questions = questionsKO;
let resultMessages = resultMessagesKO;

// 전역 변수
let currentQuestionIndex = 0;
let answers = [];

// DOM 요소
const questionContainer = document.getElementById('question-container');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const submitBtn = document.getElementById('submit-btn');
const surveyContainer = document.getElementById('survey');
const resultContainer = document.getElementById('result');
const scoreDisplay = document.getElementById('score-display');
const resultMessageElement = document.getElementById('result-message');
const restartBtn = document.getElementById('restart-btn');
const backToMainBtn = document.getElementById('back-to-main-btn');

// 언어에 따라 설문 데이터 업데이트
function updateSurveyLanguage(lang) {
    if (lang === 'en') {
        questions = questionsEN;
        resultMessages = resultMessagesEN;
    } else if (lang === 'es') {
        questions = questionsES;
        resultMessages = resultMessagesES;
    } else {
        questions = questionsKO;
        resultMessages = resultMessagesKO;
    }
    
    // 현재 보고 있는 질문 업데이트
    if (surveyContainer.style.display !== 'none') {
        showQuestion(currentQuestionIndex);
    }
    
    // 결과 창이 표시 중이라면 결과도 업데이트
    if (resultContainer.style.display !== 'none') {
        const score = calculateScore();
        scoreDisplay.textContent = `${lang === 'ko' ? '총점: ' : lang === 'en' ? 'Total Score: ' : 'Puntuación Total: '}${score}점`;
        resultMessageElement.textContent = getResultMessage(score);
    }
}

// 초기화
function init() {
    currentQuestionIndex = 0;
    answers = new Array(questions.length).fill(null);
    showQuestion(currentQuestionIndex);
    surveyContainer.style.display = 'block';
    resultContainer.style.display = 'none';
}

// 질문 표시
function showQuestion(index) {
    const question = questions[index];
    
    let optionsHTML = '';
    question.options.forEach((option, i) => {
        const isSelected = answers[index] === i;
        optionsHTML += `
            <div class="option ${isSelected ? 'selected' : ''}" data-index="${i}">
                ${option.text}
            </div>
        `;
    });

    questionContainer.innerHTML = `
        <div class="question">
            <div class="question-text">${index + 1}. ${question.question}</div>
            <div class="options">${optionsHTML}</div>
        </div>
    `;

    // 옵션 클릭 이벤트 추가
    document.querySelectorAll('.option').forEach(option => {
        option.addEventListener('click', () => {
            const optionIndex = parseInt(option.getAttribute('data-index'));
            answers[currentQuestionIndex] = optionIndex;
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
        });
    });

    // 버튼 상태 업데이트
    updateButtonsState();
}

// 버튼 상태 업데이트
function updateButtonsState() {
    prevBtn.disabled = currentQuestionIndex === 0;
    
    const isLastQuestion = currentQuestionIndex === questions.length - 1;
    nextBtn.style.display = isLastQuestion ? 'none' : 'block';
    submitBtn.style.display = isLastQuestion ? 'block' : 'none';
}

// 이전 질문으로 이동
function goToPreviousQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        showQuestion(currentQuestionIndex);
    }
}

// 다음 질문으로 이동
function goToNextQuestion() {
    if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        showQuestion(currentQuestionIndex);
    }
}

// 점수 계산
function calculateScore() {
    let totalScore = 0;
    
    answers.forEach((answerIndex, questionIndex) => {
        if (answerIndex !== null) {
            totalScore += questions[questionIndex].options[answerIndex].score;
        }
    });
    
    return totalScore;
}

// 결과 메시지 가져오기
function getResultMessage(score) {
    for (const result of resultMessages) {
        if (score >= result.minScore && score <= result.maxScore) {
            return result.message;
        }
    }
    return "결과를 분석할 수 없습니다.";
}

// 결과 표시
function showResult() {
    const score = calculateScore();
    const message = getResultMessage(score);
    
    // 언어에 따른 점수 표시
    const lang = localStorage.getItem('selectedLanguage') || 'ko';
    scoreDisplay.textContent = `${lang === 'ko' ? '총점: ' : lang === 'en' ? 'Total Score: ' : 'Puntuación Total: '}${score}점`;
    resultMessageElement.textContent = message;
    
    surveyContainer.style.display = 'none';
    resultContainer.style.display = 'block';
}

// 메인 페이지로 이동
function goToMainPage() {
    const lang = localStorage.getItem('selectedLanguage') || 'ko';
    window.location.href = `index.html?lang=${lang}`;
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    // 공통 언어 설정 적용
    if (typeof applyStoredLanguageToPage === 'function') {
        applyStoredLanguageToPage();
    }
    
    // 초기화
    init();
    
    // 이벤트 리스너
    prevBtn.addEventListener('click', goToPreviousQuestion);
    nextBtn.addEventListener('click', goToNextQuestion);
    submitBtn.addEventListener('click', showResult);
    restartBtn.addEventListener('click', init);
    backToMainBtn.addEventListener('click', goToMainPage);
});